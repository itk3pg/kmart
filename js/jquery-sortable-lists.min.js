/*
 GNU General public license
*/
(function(d){d.fn.sortableLists=function(g){function p(a){if(b.isDragged){var f=b.cEl,c=b.doc,t=b.win;a.pageX||A(a);c.scrollTop()>b.rootEl.offset.top-10&&50>a.clientY?b.upScroll?(a.pageY-=e.scroll,d("html, body").each(function(a){d(this).scrollTop(d(this).scrollTop()-e.scroll)}),q(a)):h(a):c.scrollTop()+t.height()<b.rootEl.offset.top+b.rootEl.el.outerHeight(!1)+10&&50>t.height()-a.clientY?b.downScroll?(a.pageY+=e.scroll,d("html, body").each(function(a){d(this).scrollTop(d(this).scrollTop()+e.scroll)}),
q(a)):n(a):v(b);b.oElOld=b.oEl;f.el[0].style.visibility="hidden";b.oEl=oEl=B(a.pageX,a.pageY);f.el[0].style.visibility="visible";C(a,b);D(a,b)}}function m(a){var f=b.cEl,c=d("#sortableListsHint",b.rootEl.el),t=l[0].style,k=null,g=!1,h=d("#sortableListsHintWrapper");b.isDragged=!1;"block"==t.display&&c.length&&b.isAllowed?(k=c,g=!0):(k=b.placeholderNode,g=!1);offset=k.offset();f.el.animate({left:offset.left-b.cEl.mL,top:offset.top-b.cEl.mT},250,function(){E(f);k.after(f.el[0]);k[0].style.display="none";
t.display="none";c.remove();h.removeAttr("id").removeClass(e.hintWrapperClass);h.length&&h.prev("div").append(w.clone(!0));g?b.placeholderNode.slideUp(150,function(){b.placeholderNode.remove();x()}):(b.placeholderNode.remove(),x());e.complete(f.el)});v(b);b.doc.unbind("mousemove",p).unbind("mouseup",m)}function h(a){b.upScroll||(b.upScroll=setInterval(function(){b.doc.trigger("mousemove")},50))}function n(a){b.downScroll||(b.downScroll=setInterval(function(){b.doc.trigger("mousemove")},50))}function q(a){b.pY=
a.pageY;b.pX=a.pageX;b.cY=a.clientY;b.cX=a.clientX}function A(a){a.pageY=b.pY;a.pageX=b.pX;a.clientY=b.cY;a.clientX=b.cX}function v(a){clearInterval(a.upScroll);clearInterval(a.downScroll);a.upScroll=a.downScroll=!1}function D(a,b){var c=b.cEl;c.el.css({top:a.pageY-c.xyOffsetDiff.Y-c.mT,left:a.pageX-c.xyOffsetDiff.X-c.mL})}function B(a,f){if(!document.elementFromPoint)return null;var c=b.isRelEFP;if(null===c){var e,k;0<(e=b.doc.scrollTop())&&(c=null==(k=document.elementFromPoint(0,e+d(window).height()-
1))||"HTML"==k.tagName.toUpperCase());0<(e=b.doc.scrollLeft())&&(c=null==(k=document.elementFromPoint(e+d(window).width()-1,0))||"HTML"==k.tagName.toUpperCase())}c&&(a-=b.doc.scrollLeft(),f-=b.doc.scrollTop());c=d(document.elementFromPoint(a,f));if(b.rootEl.el.find(c).length){if(c.is("#sortableListsPlaceholder")||c.is("#sortableListsHint"))return null;if(!c.is("li"))return c=c.closest("li"),c[0]?c:null;if(c.is("li"))return c}else return null}function C(a,f){var c=f.oEl;if(c&&f.oElOld){var g=c.outerHeight(!1),
k=a.pageY-c.offset().top;if(5>k)a:{d("#sortableListsHintWrapper",b.rootEl.el).length&&l.unwrap();if(a.pageX-c.offset().left<e.insertZone){if(c.prev("#sortableListsPlaceholder").length){l.css("display","none");break a}c.before(l)}else{g=c.children();k=c.children("ul").first();if(k.children().first().is("#sortableListsPlaceholder")){l.css("display","none");break a}k.length?k.prepend(l):(g.first().after(l),l.wrap(y));b.oEl&&r(c)}l.css("display","block");b.isAllowed=e.isAllowed(b.cEl.el,d("#sortableListsHint"),
c)}else if(g-5<k)a:{d("#sortableListsHintWrapper",b.rootEl.el).length&&l.unwrap();if(a.pageX-c.offset().left<e.insertZone){if(c.next("#sortableListsPlaceholder").length){l.css("display","none");break a}c.after(l)}else{g=c.children();k=c.children(e.listSelector).last();if(k.children().last().is("#sortableListsPlaceholder")){l.css("display","none");break a}k.length?g.last().append(l):(c.append(l),l.wrap(y));b.oEl&&r(c)}l.css("display","block");b.isAllowed=e.isAllowed(b.cEl.el,d("#sortableListsHint"),
c)}}}function r(a){a.removeClass("sortableListsClosed").addClass("sortableListsOpen");a.children("ul, ol").css("display","block");a.children("div").children(".sortableListsOpener").first().css("background-image","url("+e.opener.close+")")}function z(a){a.removeClass("sortableListsOpen").addClass("sortableListsClosed");a.children("ul, ol").css("display","none");a.children("div").children(".sortableListsOpener").first().css("background-image","url("+e.opener.open+")")}function E(a){var b=a.el[0].style;
a.el.removeClass(e.currElClass+" sortableListsCurrent");b.top="0";b.left="0";b.position="relative";b.width="auto"}function x(){d(e.listSelector,b.rootEl.el).each(function(a){d(this).children().length||(d(this).prev("div").children(".sortableListsOpener").first().remove(),d(this).remove())})}var u=d("body").css("position","relative"),F={currElClass:"",placeholderClass:"",placeholderCss:{position:"relative",padding:0},hintClass:"",hintCss:{display:"none",position:"relative",padding:0},hintWrapperClass:"",
hintWrapperCss:{},baseClass:"",baseCss:{position:"absolute",top:0-parseInt(u.css("margin-top")),left:0-parseInt(u.css("margin-left")),margin:0,padding:0,"z-index":2500},opener:{active:!1,open:"",close:"",openerCss:{"float":"left",display:"inline-block","background-position":"center center","background-repeat":"no-repeat"},openerClass:""},listSelector:"ul",listsClass:"",listsCss:{},insertZone:50,scroll:20,ignoreClass:"",isAllowed:function(a,b){return!0},onDragStart:function(a,b){return!0},complete:function(a){return!0}},
e=d.extend(!0,{},F,g),G=d("<"+e.listSelector+" />").prependTo(u).attr("id","sortableListsBase").css(e.baseCss).addClass(e.listsClass+" "+e.baseClass),H=d("<li />").attr("id","sortableListsPlaceholder").css(e.placeholderCss).addClass(e.placeholderClass),l=d("<li />").attr("id","sortableListsHint").css(e.hintCss).addClass(e.hintClass),y=d("<"+e.listSelector+" />").attr("id","sortableListsHintWrapper").addClass(e.listsClass+" "+e.hintWrapperClass).css(e.listsCss).css(e.hintWrapperCss),w=d("<span />").addClass("sortableListsOpener "+
e.opener.openerClass).css("background-image","url("+e.opener.close+")").css(e.opener.openerCss).on("mousedown",function(a){a=d(this).closest("li");a.hasClass("sortableListsClosed")?r(a):z(a);return!1}),b={isRelEFP:null,oEl:null,rootEl:null,cEl:null,upScroll:!1,downScroll:!1,pX:0,pY:0,cX:0,cY:0,isAllowed:!0,e:{pageX:0,pageY:0,clientX:0,clientY:0},doc:d(document),win:d(window)};if(e.opener.active){if(!e.opener.open)throw"Url for opener.open image is not defined";if(!e.opener.close)throw"Url for opener.close image is not defined";
d(this).find("li").each(function(){var a=d(this);a.children("ul,ol").length&&(w.clone(!0).prependTo(a.children("div").first()),a.hasClass("sortableListsOpen")||(a.addClass("sortableListsClosed"),z(a)))})}return this.on("mousedown",function(a){var f=d(a.target);if(!f.hasClass(e.ignoreClass)){a.preventDefault();var f=f.is("li")?f:f.closest("li"),c=d(this);if(f[0]){e.onDragStart(a,f);b.isDragged=!0;var g=parseInt(f.css("margin-top")),k=parseInt(f.css("margin-bottom")),h=parseInt(f.css("margin-left")),
n=parseInt(f.css("margin-right")),q=f.offset(),r=f.innerHeight();b.rootEl={el:c,offset:c.offset(),rootElClass:c.attr("class")};b.cEl={el:f,mT:g,mL:h,mB:k,mR:n,offset:q};b.cEl.xyOffsetDiff={X:a.pageX-b.cEl.offset.left,Y:a.pageY-b.cEl.offset.top};b.cEl.el.addClass("sortableListsCurrent "+e.currElClass);f.before(H);a=b.placeholderNode=d("#sortableListsPlaceholder");f.css({width:f.width(),position:"absolute",top:q.top-g,left:q.left-h}).prependTo(G);a.css({display:"block",height:r});l.css("height",r);
b.doc.on("mousemove",p).on("mouseup",m)}}})};d.fn.sortableListsToArray=function(g,p){g=g||[];var m=0;this.children("li").each(function(){var h=d(this),n={},q=h.attr("id");if(!q)throw console.log(h),"Previous item in console.log has no id. It is necessary to create the array.";n.id=q;n.parentId=p;n.value=h.data("value");n.order=m;g.push(n);h.children("ul,ol").sortableListsToArray(g,q);m++});return g};d.fn.sortableListsToHierarchy=function(){var g=[],p=0;d(this).children("li").each(function(){var m=
d(this),h={},n=m.attr("id");if(!n)throw console.log(m),"Previous item in console.log has no id. It is necessary to create the array.";h.id=n;h.value=m.data("value");h.order=p;g.push(h);h.children=m.children("ul,ol").sortableListsToHierarchy();p++});return g};d.fn.sortableListsToString=function(g,p){g=g||[];p=p||"";d(this).children("li").each(function(){var m=d(this),h=m.attr("id");if(!h)throw console.log(m),"Previous item in console.log has no id. It is necessary to create the array.";g.push(encodeURIComponent(h)+
"="+encodeURIComponent(p));d(this).children("ul,ol").sortableListsToString(g,h)});return g.join("&")}})(jQuery);
